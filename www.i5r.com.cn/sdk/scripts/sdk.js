function TangSdk(){}TangSdk.tangideURL="http://www.tangide.com";TangSdk.gameserverURL="http://www.i5r.com.cn";TangSdk.appendURI=function(e,t,a){e+=e.indexOf("?")>0?"&":"?";e=e+encodeURIComponent(t)+"="+encodeURIComponent(a);return e};TangSdk.makeQuery=function(e){var t="";for(key in e){t+="&"+key+"="+e[key]}return t.substr(1)};TangSdk.getAppid=function(){var e=window.location.href;var t=e.indexOf("-")+1;var a=e.indexOf(".html");return e.slice(t,a)};TangSdk.parseQuery=function(e){var t={};e=e||window.location.href;var a=e.indexOf("?");if(a>-1){var n=e.substring(a+1).split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i!==2){i.push("")}var o=decodeURIComponent(i[0]);var p=decodeURIComponent(i[1]);t[o]=p}}if(!t.appid){t.appid=TangSdk.getAppid()}return t};TangSdk.isPhoneGap=function(){if(location.protocol==="http:"||location.protocol==="https:"){return false}return true};TangSdk.isWeixin=function(){return navigator&&navigator.userAgent.indexOf("MicroMessenger")>=0};TangSdk.isGameCenter=function(){return window.location.href.indexOf(this.gameserverURL)>=0};TangSdk.isTangIDE=function(){return window.location.href.indexOf(this.tangideURL)>=0};TangSdk.currentHost=function(){var e=location.protocol==="https:"?"https:":"http:";return e+"//"+location.host};TangSdk.inValidUserType=function(e){return!e||e!="qq"&&e!="weibo"&&e!="wechat"&&e!="wechat-mobile"};TangSdk.makeURL=function(e,t,a){a=a||"";if(e!=this.gameserverURL&&e!=this.tangideURL){a=t;t=e;e=this.gameserverURL}if(typeof a==="object"){a=this.makeQuery(a)}var n=e+t;if(a){n+="?"+a}if(this.magic){n=this.appendURI(n,"magic",magic)}return n};TangSdk.prototype.returnData=function(e,t,a){var n={code:0,message:"success"};if(typeof e==="function"){a=e;a(n);return}if(typeof t==="function"){a=t;t=""}if(e){return a({code:-1,message:e})}if(t){n.data=t}a(n)};TangSdk.prototype.storageSet=function(e,t){localStorage.setItem(e,t)};TangSdk.prototype.storageGet=function(e){return localStorage.getItem(e)};TangSdk.prototype.getClientID=function(){var e=this.storageGet("clientID");if(e==null){e=this.getUUID();this.storageSet("clientID",e)}return e};TangSdk.prototype.getMagic=function(){return magic=this.storageGet("magic")};TangSdk.prototype.setMagic=function(e){this.storageSet("magic",e)};TangSdk.prototype.getUUID=function(){var e=0;var t=["0","1","2","3","4","5","6","7","8","9"];var a="";var n=Math.floor(t.length);for(var r=0;r<n;r++){var i=Math.ceil(Math.random()*9);a+=t[i]}var o=new Date;var p=o.getTime()+a;for(var s=0;s<p.length;s++){var d=p.charCodeAt(s);e=(e<<5)-e+d;e=e&e}return e};TangSdk.prototype.prepare=function(){var e=this.getMagic();if(!e){var t=TangSdk.makeURL("/apps/prepare.php");var a=this;httpApiRequest(t,"POST",null,function(e){TangSdk.magic=e.data;a.setMagic(e.data)})}};TangSdk.prototype.isPhoneGap=function(){return TangSdk.isPhoneGap()};TangSdk.prototype.setAppID=function(e){this.appid=e||"";this.like={};return this};TangSdk.prototype.shareQzoneByWebApp=function(e,t,a,n){var r="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";var i={url:location.href,showcount:1,desc:"",summary:e,title:t,pics:a,site:"Tangram",style:"203",width:98,height:22};var o=[];for(var p in i){o.push(p+"="+encodeURIComponent(i[p]||""))}var s=r+o.join("&");var d=document.getElementById("shareLink");d.setAttribute("href",s);d.click();this.returnData(n)};TangSdk.prototype.shareQzoneByPhoneGap=function(e,t,a,n,r){var i={appid:n,title:t,image_url:a,summary:e,target_url:TangSdk.gameserverURL};var o=this;window.qq.sharedToQzone(i,function(e){o.returnData(r)},function(e){o.returnData(err,r)})};TangSdk.prototype.shareQzone=function(e,t,a,n,r){if(TangSdk.isPhoneGap()){if(!r.appid){this.returnData("not set appid")}else{this.shareQzoneByPhoneGap(e,t,a,r.appid,n)}}else{this.shareQzoneByWebApp(e,t,a,n)}};TangSdk.prototype.shareWeiboByWebApp=function(e,t,a){var n={pic:t,message:e,action:"send-message"};var r=TangSdk.makeURL("/users/"+this.userType+".php");httpApiRequest(r,"POST",JSON.stringify(n),a)};TangSdk.prototype.shareWeiboByPhoneGap=function(e,t,a){var n={text:t,data:e,type:e?"image":"text"};var r=this;function i(){window.weibo.share(n,function(e){r.returnData(a)},function(e){r.returnData(JSON.stringify(e),a)})}window.weibo.init(appid,redirectURL,function(e){i()},function(e){r.returnData(JSON.stringify(e),a)})};TangSdk.prototype.shareWeibo=function(e,t,a,n){this.userType="weibo";if(TangSdk.isPhoneGap()){if(!n.appid){this.returnData("not setup appid",a)}else{this.shareWeiboByPhoneGap(t,e,a)}}else{this.shareWeiboByWebApp(e,t,a)}};TangSdk.prototype.shareWechat=function(e,t,a,n,r,i){if(!TangSdk.isPhoneGap()){this.returnData("not implement",n)}else{if(!r.appid){return this.returnData("not setup appid",n)}var o={};o.title=e;o.description=t;o.thumb=a;o.media={type:Wechat.Type.WEBPAGE,webpageUrl:i||TangSdk.gameserverURL};var p=this;Wechat.share(r.appid,{message:o,scene:Wechat.Scene.TIMELINE},function(e){p.returnData(n)},function(e){p.returnData(e,n)})}};TangSdk.prototype.isLogined=function(e){if(!this.userType){this.returnData("not login",e)}else{var t={action:"islogined"};if(TangSdk.isTangIDE()){t.action="getUserInfo";var a=TangSdk.makeURL(TangSdk.tangideURL,"/users/"+this.userType+".php",t)}else{var a=TangSdk.makeURL(TangSdk.gameserverURL,"/users/"+this.userType+".php",t)}httpApiRequest(a,"POST",null,e)}};TangSdk.prototype.uploadUserInfo=function(e){var t=TangSdk.makeURL(TangSdk.gameserverURL,"/users/"+this.userType+".php",{action:"add-user"});httpApiRequest(t,"POST",JSON.stringify({userInfo:e}),function(e){if(e.code===0){console.log("uploadUserInfo success")}else{console.log("uploadUserInfo fail")}})};TangSdk.prototype.login=function(e){if(TangSdk.inValidUserType(this.userType)){this.returnData("invalid user type",e)}else{var t=window.location.href;t=btoa(encodeURIComponent(t));var a=TangSdk.currentHost();var n=TangSdk.makeURL(a,"/users/"+this.userType+".php",{action:"init",fromtangram:t});window.location.href=n;this.returnData(e)}};TangSdk.prototype.qqLogin=function(e,t){this.userType="qq";if(TangSdk.isPhoneGap()){if(!t.appid){this.returnData("not setup appid",e)}else{var a=this;window.qq.qqLogin({appid:t.appid},function(n){t.userInfo=n;a.uploadUserInfo(n);a.returnData(null,n,e)},function(t){a.returnData(t,e)})}return}return this.login(e)};TangSdk.prototype.weiboLoginPhoneGap=function(e,t){var a="https://api.weibo.com/oauth2/default.html";var n=this;function r(){window.weibo.login(function(e){n.uploadUserInfo(e);n.returnData(null,e,t)},function(e){n.returnData(e,t)})}window.weibo.init(e,a,function(e){r()},function(e){n.returnData(e,t)})};TangSdk.prototype.weiboLogin=function(e,t){this.userType="weibo";if(TangSdk.isPhoneGap()){if(!t.appid){this.returnData("not setup appid",e)}else{this.weiboLoginPhoneGap(t.appid,e)}}else{this.login(e)}};TangSdk.prototype.wechatPhoneGapLogin=function(e,t,a){var n=this;function r(e){var t="https://api.weixin.qq.com/sns/userinfo?"+"access_token="+e.access_token+"&openid="+e.openid;httpApiRequest(t,"GET",null,function(e){if(e.errcode){n.returnData(e,a)}else{var t={};t.id=e.openid;t.name=e.nickname;t.image=e.headimgurl;t.gender=e.sex===1?"男":"女";t.location=e.country+e.province+e.city;a({code:0,message:"success",data:t});n.uploadUserInfo(t);n.returnData(null,e,a)}})}function i(i){var o="https://api.weixin.qq.com/sns/oauth2/access_token?"+"appid="+e+"&secret="+t+"&code="+i+"&grant_type=authorization_code";httpApiRequest(o,"GET",null,function(e){if(e.errcode){n.returnData(e,a)}else{r(e)}})}var o="snsapi_userinfo";Wechat.auth(e,o,function(e){i(e.code)},function(e){n.returnData(e,a)})};TangSdk.prototype.wechatLogin=function(e,t){if(TangSdk.isWeixin()){this.userType="wechat-mobile"}else{this.userType="wechat";if(TangSdk.isPhoneGap()){if(!t.appid||!t.secret){return this.returnData("not setup appid or secret",e)}return this.wechatPhoneGapLogin(t.appid,t.secret,e)}}this.login(e)};TangSdk.prototype.logout=function(e){if(!this.userType){this.returnData(e)}else{var t=TangSdk.currentHost();var a=TangSdk.makeURL(t,"/users/"+this.userType+".php",{action:"logout"});this.userType="";var n=e;return httpApiRequest(a,"POST",null,function(e){n(e);if(e&&e.code===0){location=location}})}};TangSdk.prototype.starApp=function(e,t){if(!this.appid||e<0||e>5){return t({code:-1,message:"invalid params"})}var a=this.getClientID();var n=TangSdk.makeURL("/apps/star.php",{appid:this.appid,star:e,uuid:a});httpApiRequest(n,"POST",null,t);return};TangSdk.prototype.saveAppData=function(e,t){if(!this.appid){return t({code:-1,message:"no set appid"})}var a=TangSdk.makeURL("/apps/save-data.php",{appid:this.appid});httpApiRequest(a,"POST",e,t);return};TangSdk.prototype.loadAppData=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=TangSdk.makeURL("/apps/load-data.php",{appid:this.appid});httpApiRequest(t,"POST",null,e);return};TangSdk.prototype.cancelLikeApp=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=this.getClientID();var a=TangSdk.makeURL("/apps/cancel-like.php",{appid:this.appid,uuid:t});httpApiRequest(a,"POST",null,e);return};TangSdk.prototype.unlikeApp=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=this.getClientID();var a=TangSdk.makeURL("/apps/unlike.php",{appid:this.appid,uuid:t});httpApiRequest(a,"POST",null,e);return};TangSdk.prototype.forkApp=function(e,t){if(!this.appid||!e){return t({code:-1,message:"invalid params"})}var a=TangSdk.makeURL("/apps/fork.php",{appid:this.appid,appidFork:e});httpApiRequest(a,"POST",null,t);return};TangSdk.prototype.listForks=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=TangSdk.makeURL("/apps/list-forks.php",{appid:this.appid});httpApiRequest(t,"POST",null,e);return};TangSdk.prototype.likeApp=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=this.getClientID();var a=TangSdk.makeURL("/apps/like.php",{appid:this.appid,uuid:t});httpApiRequest(a,"POST",null,e);return};TangSdk.prototype.getHighScore=function(e,t){if(!this.appid){return e({code:-1,message:"no set appid"})}if(typeof t!=="number"){return e({code:-1,message:"invalid params"})}t=t||100;var a=TangSdk.makeURL("/apps/get-high-score.php",{limit:t,appid:this.appid});httpApiRequest(a,"POST",null,e)};TangSdk.prototype.getFriendsScore=function(e,t){var a=t||100;var n=TangSdk.makeURL("/apps/get-friends-score.php",{limit:a,appid:this.appid});httpApiRequest(n,"POST",null,e)};TangSdk.prototype.getPlayStatis=function(e){var t=TangSdk.makeURL("/apps/get-play-statis.php",{appid:this.appid});httpApiRequest(t,"POST",null,e)};TangSdk.prototype.saveScore=function(e,t){if(!this.appid){return t({code:-1,message:"no set appid"})}e=parseInt(e,10);if(!e||isNaN(e)){return t({code:-1,message:"invalid params"})}var a=this.getClientID();var n=this.encrypt(e);var r=TangSdk.makeURL("/apps/save-score.php",{uuid:a});var i={appid:this.appid,score:n};httpApiRequest(r,"POST",JSON.stringify(i),t)};TangSdk.prototype.loadScore=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=TangSdk.makeURL("/apps/load-score.php",{appid:this.appid});httpApiRequest(t,"POST",null,e);return};TangSdk.prototype.getPlayerStatis=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}console.log("appid: "+this.appid);var t=this.getClientID();var a=TangSdk.makeURL("/apps/getplayer-statis.php",{uuid:t,appid:this.appid});httpApiRequest(a,"POST",null,e)};TangSdk.prototype.getPlayersScore=function(e,t){if(!this.appid||typeof e!=="object"||!e.length){return t({code:-1,message:"invalid params"})}var a=TangSdk.makeURL("/apps/get-players-score.php",{appid:this.appid,players:JSON.stringify(e)});httpApiRequest(a,"POST",null,t);return};TangSdk.prototype.addFavorite=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=TangSdk.makeURL("/apps/add-favorite.php",{appid:this.appid});httpApiRequest(t,"POST",null,e);return};TangSdk.prototype.removeFavorite=function(e){if(!this.appid){return e({code:-1,message:"no set appid"})}var t=TangSdk.makeURL("/apps/remove-favorite.php",{appid:this.appid});httpApiRequest(t,"POST",null,e);return};TangSdk.prototype.encrypt=function(e){var t="";var a="dfsdkljfkdsf--...Ajdsak1230";var n=a;if(typeof e!=="string"){e=e.toString()}for(var r=0;r<n.length;r++){t+=n.charCodeAt(r).toString()}var i=Math.floor(t.length/5);var o=parseInt(t.charAt(i)+t.charAt(i*2)+t.charAt(i*3)+t.charAt(i*4)+t.charAt(i*5));var p=Math.ceil(n.length/2);var s=Math.pow(2,31)-1;if(o<2){return null}var d=Math.round(Math.random()*1e9)%1e8;t+=d;while(t.length>10){t=(parseInt(t.substring(0,10))+parseInt(t.substring(10,t.length))).toString()}t=(o*t+p)%s;var u="";var c="";for(var r=0;r<e.length;r++){u=parseInt(e.charCodeAt(r)^Math.floor(t/s*255));if(u<16){c+="0"+u.toString(16)}else c+=u.toString(16);t=(o*t+p)%s}d=d.toString(16);while(d.length<8)d="0"+d;c+=d;return c};TangSdk.prototype.decrypt=function(e){if(e==null||e.length<8){return}var t="dfsdkljfkdsf--...Ajdsak1230";var a=t;if(a==null||a.length<=0){return}var n="";for(var r=0;r<a.length;r++){n+=a.charCodeAt(r).toString()}var i=Math.floor(n.length/5);var o=parseInt(n.charAt(i)+n.charAt(i*2)+n.charAt(i*3)+n.charAt(i*4)+n.charAt(i*5));var p=Math.round(a.length/2);var s=Math.pow(2,31)-1;var d=parseInt(e.substring(e.length-8,e.length),16);e=e.substring(0,e.length-8);n+=d;while(n.length>10){n=(parseInt(n.substring(0,10))+parseInt(n.substring(10,n.length))).toString()}n=(o*n+p)%s;var u="";var c="";for(var r=0;r<e.length;r+=2){u=parseInt(parseInt(e.substring(r,r+2),16)^Math.floor(n/s*255));c+=String.fromCharCode(u);n=(o*n+p)%s}return c};TangSdk.prototype.sendRedpack=function(e,t){var a=TangSdk.makeURL("/redpack.php",{action:"send"});httpApiRequest(a,"POST",JSON.stringify(e),t)};TangSdk.prototype.getJiMeiCoupon=function(e,t,a,n,r){a=a||0;n=n||0;var i=TangSdk.makeURL("/jumei-coupon.php",{action:"get-coupon",authID:e,couponID:t,tel:a,score:n});httpApiRequest(i,"POST",null,r)};TangSdk.prototype.saveFriendData=function(e,t,a){if(!e){return a({code:-1,message:"no frinedID"})}else if(!t){return a({code:-1,message:"empty data"})}var n=TangSdk.makeURL("/friends/friends-data.php",{action:"save-data",friendInfo:e});httpApiRequest(n,"POST",t,a)};TangSdk.prototype.loadFriendData=function(e){var t=TangSdk.makeURL("/friends/friends-data.php",{action:"load-data"});httpApiRequest(t,"POST",null,e)};TangSdk.prototype.listTeamRank=function(e,t,a){var n=TangSdk.makeURL("/team-manager.php",{appid:this.appid,limit:e,dstdate:t,action:"list-all"});httpApiRequest(n,"POST",null,a)};TangSdk.prototype.listTeamPlayHistory=function(e,t){var a=TangSdk.makeURL("/team-manager.php",{appid:this.appid,startDate:e||"",action:"list-record"});httpApiRequest(a,"POST",null,t)};TangSdk.prototype.getTeamMaxScore=function(e){var t=TangSdk.parseQuery();if(!t||!t.leader){return e({code:0,message:"new user",data:0})}var a=TangSdk.makeURL("/team-manager.php",{appid:this.appid,leader:t.leader,action:"team-maxscore"});httpApiRequest(a,"POST",null,e)};TangSdk.prototype.saveTeamScore=function(e,t){if(!this.appid){t({code:-1,message:"not setup appid"});return}e=parseInt(e,10);if(!e||isNaN(e)){return t({code:-1,message:"invalid params"})}var a=TangSdk.parseQuery();if(!a||!a.leader||!a.expires){t({code:-1,message:"invalid url"});return}var n=this.encrypt(e);var r=TangSdk.makeURL("/team-manager.php");var i={score:n,appid:this.appid,leader:a.leader,expires:a.expires,action:"save-score"};httpApiRequest(r,"POST",JSON.stringify(i),t)};TangSdk.prototype.restartGame=function(){var e=window.location.href;var t=TangSdk.appendURI(e,"restart",1);window.location.href=t};TangSdk.prototype.expired=function(e){var t=TangSdk.parseQuery();var a=t.expires||"";var n=TangSdk.makeURL("/team-manager.php",{action:"expires",expires:a});httpApiRequest(n,"POST",null,e)};var XHRHttp=function(){if(typeof window==="undefined"){throw new Error("no window object persent")}else if(window.XMLHttpRequest){return window.XMLHttpRequest}else if(window.ActiveXObject){var e=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];for(var t=0;t<e.length;t++){try{var a=new window.ActiveXObject(e[t]);return function(){if(a){var n=a;a=null;return n}else{return new window.ActiveXObject(e[t])}}}catch(n){}}throw new Error("ajax not supported in this browser")}else{throw new Error("ajax not supported in this browser")}}();function creatXMLHTTPRequest(){var e=new XHRHttp;return e}function httpDoRequest(e){var t=creatXMLHTTPRequest();if(!e||!e.url){return false}var a=e.url;var n=e.data;var r=e.method?e.method:"GET";t.open(r,a,true);if(e.noCache){t.setRequestHeader("If-Modified-Since",0)}if(e.headers){for(var i in e.headers){var o=e.headers[i];t.setRequestHeader(i,o)}}if(t){t.send(e.data?e.data:null);if(!t.onprogress){t.onreadystatechange=function(){if(e.onProgress){e.onProgress(t)}if(t.readyState===4){if(e.onDone){e.onDone(true,t,t.responseText);console.log("response:"+t.responseText)}}console.log("onreadystatechange:"+t.readyState);return}}else{t.onprogress=function(a){var n=a.total;if(e.onProgress){e.onProgress(t)}console.log("get:"+n)};t.onload=function(a){if(e.onDone){e.onDone(true,t,a.target.responseText)}};t.onerror=function(a){if(e.onDone){e.onDone(false,t,t.responseText)}}}}return true}function httpApiRequest(e,t,a,n,r){var i={};i.url=e;i.data=a;i.noCache=true;i.noProxy=false;i.method=t?t:"GET";i.onDone=function(e,t,a){try{var i=r?a:JSON.parse(a)}catch(o){var i={};i.code=-1;i.message=o.message;n(i);console.log(o.message);return}try{n(i)}catch(o){console.log(o.message);return}};httpDoRequest(i);return}function GameSDK(){}GameSDK.createShareLink=function(){if(document.getElementById("shareLink")){return}else{var e=document.createElement("a");e.setAttribute("target","_blank");e.setAttribute("id","shareLink");var t=document.getElementsByTagName("body");if(t&&t.length){document.getElementsByTagName("body")[0].appendChild(e)}}};GameSDK.getInstance=function(){if(GameSDK.instance){return GameSDK.instance}if(location.href.indexOf("www.i5r.com.cn")>0||location.href.indexOf("www.tangide.com")>0||location.href.indexOf("file://")===0){GameSDK.instance=new TangSdk;var e=TangSdk.parseQuery();GameSDK.instance.setAppID(e.appid)}return GameSDK.instance};GameSDK.begin=function(){var e=GameSDK.getInstance();e.prepare();GameSDK.createShareLink()};GameSDK.begin();